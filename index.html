<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphique Valence/Activation des √âmotions (Analyse Psychologique)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            background-color: #f0f4f8;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #1e3a8a;
            text-align: center;
        }
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            position: relative;
            margin-top: 10px;
        }
        .chart-container svg {
            cursor: default;
        }
        .controls {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 14px;
        }
        .controls div {
            margin-bottom: 5px;
        }
        .controls label {
            cursor: pointer;
            color: #2c3e50;
            margin-left: 5px;
        }
        .controls input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
        }
        #resetPathBtn {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            margin-left: 10px;
            cursor: pointer;
        }
        #resetPathBtn:hover {
            background-color: #f3f4f6;
        }
        #category-filters { text-align: left; }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 10px;
            font-size: 13px;
            background: rgba(40, 50, 60, 0.9);
            color: white;
            border: 0px;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .axis-label {
            font-size: 15px;
            fill: #2c3e50;
            font-weight: 600;
        }
        .tick text {
            font-size: 10px;
            fill: #555;
        }
        .quadrant-label {
            font-size: 10px;
            fill: #7f8c8d;
            text-anchor: middle;
            font-style: italic;
        }
        .emotion-label-text {
            font-size: 8px;
            fill: #1a202c;
            pointer-events: none;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 25px;
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 12px;
            margin-bottom: 8px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .legend-item:hover {
            background-color: #f0f4f8;
        }
        .legend-color {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }
        .controlateral-line {
            stroke: #a0aec0;
            stroke-width: 1px;
            stroke-dasharray: "3,3";
        }
        .symetrical-line {
             stroke: #718096;
             stroke-width: 1.2px;
        }
        .path-line {
            stroke: #2c3e50;
            stroke-width: 2px;
            fill: none;
        }
        .path-point-highlight {
            stroke: #e53e3e !important;
            stroke-width: 3px !important;
        }
        .intensity-circle {
            stroke: #4a5568;
            stroke-width: 1.5px;
            stroke-dasharray: "4,4";
            fill: none;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        .grid .tick line {
            stroke: #e0e0e0;
            stroke-dasharray: 2,2;
        }
        .grid path.domain { stroke: none; }
        .axis-center-line {
            stroke: #7f8c8d;
            stroke-width: 1.5px;
        }
        .ia-response-container {
            margin-top: 25px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 800px;
        }
        .ia-response-container h2 {
            color: #1e3a8a;
            margin-bottom: 10px;
        }
        .ia-response-content {
            min-height: 50px;
            padding:10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background-color: #f9fafb;
            color: #374151;
            white-space: pre-wrap;
        }
        .identity-card-section { margin-bottom: 1rem; }
        .identity-card-section h4 { font-weight: 600; color: #4338ca; margin-bottom: 0.25rem; }
        .identity-card-section p { font-size: 0.9rem; color: #374151; }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <h1 class="text-3xl font-bold my-6">Graphique Valence (V) vs. Activation (A) des √âmotions</h1>

    <div class="controls bg-white p-4 rounded-lg shadow mb-4">
        <div class="text-center">
            <div class="inline-block text-left mr-4">
                <input type="checkbox" id="showNamesToggle" class="mr-2 align-middle" checked>
                <label for="showNamesToggle" class="text-sm text-gray-700">Afficher les noms</label>
            </div>
             <div class="inline-block text-left mr-4">
                <input type="checkbox" id="showIntensityCircleToggle" class="mr-2 align-middle">
                <label for="showIntensityCircleToggle" class="text-sm text-gray-700">Afficher le cercle d'intensit√©</label>
            </div>
        </div>
         <div class="mt-3 pt-3 border-t border-gray-200 text-center">
            <div class="inline-block text-left mr-4">
                <input type="checkbox" id="showControlateralToggle" class="mr-2 align-middle">
                <label for="showControlateralToggle" class="text-sm text-gray-700">Correspondances controlat√©rales</label>
            </div>
            <div class="inline-block text-left">
                <input type="checkbox" id="showSymetricalToggle" class="mr-2 align-middle">
                <label for="showSymetricalToggle" class="text-sm text-gray-700">Correspondances sym√©triques</label>
            </div>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-200 text-center">
            <input type="checkbox" id="pathModeToggle" class="mr-2 align-middle">
            <label for="pathModeToggle" class="text-sm text-gray-700 font-semibold">Mode "Chemin √âmotionnel"</label>
            <button id="resetPathBtn" style="display: none;">R√©initialiser le chemin</button>
        </div>
        <div id="category-filters" class="mt-3 pt-3 border-t border-gray-200">
            <h4 class="text-sm font-semibold mb-2 text-gray-600 text-center">Filtrer par Cat√©gorie :</h4>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-1 text-sm">
                <div><input type="checkbox" id="cat-1" class="category-filter" value="1" checked><label for="cat-1"> 1. Orientation</label></div>
                <div><input type="checkbox" id="cat-2" class="category-filter" value="2" checked><label for="cat-2"> 2. Fondamentales</label></div>
                <div><input type="checkbox" id="cat-3" class="category-filter" value="3" checked><label for="cat-3"> 3. Complexes</label></div>
                <div><input type="checkbox" id="cat-4" class="category-filter" value="4" checked><label for="cat-4"> 4. Relationnelles</label></div>
                <div><input type="checkbox" id="cat-5" class="category-filter" value="5" checked><label for="cat-5"> 5. Dispositions</label></div>
            </div>
             <div class="mt-2 text-xs text-gray-500 text-center italic">
                Note: La taille des points varie selon la cat√©gorie de l'√©motion (1 √† 5).
            </div>
        </div>
    </div>

    <div class="chart-container bg-white p-5 rounded-xl shadow-lg">
        <svg id="emotionChart"></svg>
    </div>

    <div id="scenarioAnalysisContainer" class="ia-response-container">
        <h2 class="text-xl font-semibold text-purple-700 mb-3">üîé Analyse de Texte par l'IA</h2>
        <textarea id="textInput" class="w-full p-2 border border-gray-300 rounded-md" rows="6" placeholder="Collez un sc√©nario, un article ou tout autre texte ici..."></textarea>
        <button id="analyzeTextBtn" class="mt-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">Analyser le Texte</button>
    </div>

    <div id="iaResponseContainer" class="ia-response-container hidden">
        <h2 id="iaResponseTitle" class="text-xl font-semibold text-indigo-700 mb-3">Chemin √âmotionnel Identifi√©</h2>
        <div id="iaResponseContent" class="ia-response-content">
            Les r√©sultats de l'analyse par l'IA appara√Ætront ici.
        </div>
    </div>

    <div id="psychologicalAnalysisResultContainer" class="ia-response-container hidden">
        <h2 id="psychologicalAnalysisResultTitle" class="text-xl font-semibold text-teal-700 mb-3">üìñ Analyse Psychologique du Texte</h2>
        <div id="psychologicalAnalysisResultContent" class="ia-response-content">
            L'analyse psychologique du texte appara√Ætra ici.
        </div>
    </div>

    <div id="legend" class="legend mt-6 bg-white p-3 rounded-lg shadow"></div>

    <script>
        const emotionsData = [
            // Data reverted to 5 categories, with requested changes
            { name: "Attente", code: "A0/V0", category: 1, group: "Orientation" },
            { name: "Surprise", code: "A0,5/V0", category: 1, group: "Orientation" },
            { name: "Anticipation", code: "A-0,5/V0", category: 1, group: "Orientation" },
            { name: "Joie", code: "A+2/V0", category: 2, group: "Joie" },
            { name: "Tristesse", code: "A-2/V0", category: 2, group: "Tristesse" },
            { name: "Peur", code: "A0/V-2", category: 2, group: "Peur" },
            { name: "Courage", code: "A0/V+2", category: 2, group: "Courage" },
            { name: "Col√®re", code: "A+1/V-1", category: 2, group: "Col√®re" },
            { name: "Calme", code: "A-1/V+1", category: 2, group: "Calme" },
            { name: "D√©sir", code: "A+1/V+1", category: 2, group: "D√©sir" },
            { name: "D√©go√ªt", code: "A-1/V-1", category: 2, group: "D√©go√ªt" },
            { name: "Confusion", code: "A+4/V0", category: 3, group: "Joie" },
            { name: "Consternation", code: "A+3/V-1", category: 3, group: "Joie" },
            { name: "Euphorie", code: "A+3/V+1", category: 3, group: "Joie" },
            { name: "Engourdissement", code: "A-4/V0", category: 3, group: "Tristesse" },
            { name: "R√©confort", code: "A-3/V+1", category: 3, group: "Tristesse" },
            { name: "Chagrin", code: "A-3/V-1", category: 3, group: "Tristesse" },
            { name: "Stupeur", code: "A0/V-4", category: 3, group: "Peur" },
            { name: "Panique", code: "A+1/V-3", category: 3, group: "Peur" },
            { name: "Effroi", code: "A-1/V-3", category: 3, group: "Peur" },
            { name: "Appr√©hension", code: "A0/V+4", category: 3, group: "Courage" },
            { name: "√âmerveillement", code: "A+1/V+3", category: 3, group: "Courage" },
            { name: "Enchantement", code: "A-1/V+3", category: 3, group: "Courage" },
            { name: "Exasp√©ration", code: "A+2/V-2", category: 3, group: "Col√®re" },
            { name: "Soulagement", code: "A-2/V+2", category: 3, group: "Calme" },
            { name: "Excitation", code: "A+2/V+2", category: 3, group: "D√©sir" },
            { name: "D√©ception", code: "A-2/V-2", category: 3, group: "D√©go√ªt" },
            { name: "Ambivalence", code: "A+6/V0", category: 4, group: "Joie" },
            { name: "Envie", code: "A+4/V-2", category: 4, group: "Joie" },
            { name: "Haine", code: "A+5/V-1", category: 4, group: "Joie" },
            { name: "Amour", code: "A+5/V+1", category: 4, group: "Joie" },
            { name: "Assurance", code: "A+4/V+2", category: 4, group: "Joie" },
            { name: "Indiff√©rence", code: "A-6/V0", category: 4, group: "Tristesse" },
            { name: "S√©r√©nit√©", code: "A-4/V+2", category: 4, group: "Tristesse" },
            { name: "Pl√©nitude", code: "A-5/V+1", category: 4, group: "Tristesse" },
            { name: "Honte", code: "A-4/V-2", category: 4, group: "Tristesse" },
            { name: "Vide", code: "A-5/V-1", category: 4, group: "Tristesse" },
            { name: "Anxi√©t√©", code: "A+2/V-4", category: 4, group: "Peur" },
            { name: "Manque", code: "A+1/V-5", category: 4, group: "Peur" },
            { name: "M√©pris", code: "A-1/V-5", category: 4, group: "Peur" },
            { name: "Crainte", code: "A-2/V-4", category: 4, group: "Peur" },
            { name: "Doute", code: "A0/V-6", category: 4, group: "Peur" },
            { name: "H√©sitation", code: "A0/V+6", category: 4, group: "Courage" },
            { name: "Fiert√©", code: "A+2/V+4", category: 4, group: "Courage" },
            { name: "√âpanouissement", code: "A+1/V+5", category: 4, group: "Courage" },
            { name: "Affection", code: "A-1/V+5", category: 4, group: "Courage" },
            { name: "Admiration", code: "A-2/V+4", category: 4, group: "Courage" },
            { name: "Frustration", code: "A+3/V-3", category: 4, group: "Col√®re" },
            { name: "Acceptation", code: "A-3/V+3", category: 4, group: "Calme" },
            { name: "Engagement", code: "A+3/V+3", category: 4, group: "D√©sir" },
            { name: "Rejet", code: "A-3/V-3", category: 4, group: "D√©go√ªt" },
            { name: "Agitation", code: "A+8/V0", category: 5, group: "Joie" },
            { name: "Invuln√©rabilit√©", code: "A+7/V+1", category: 5, group: "Joie" },
            { name: "Puissance", code: "A+6/V+2", category: 5, group: "Joie" },
            { name: "Confiance", code: "A+5/V+3", category: 5, group: "Joie" },
            { name: "Intol√©rance", code: "A+6/V-2", category: 5, group: "Joie" },
            { name: "Injustice", code: "A+5/V-3", category: 5, group: "Joie" },
            { name: "Imprudence", code: "A+7/V-1", category: 5, group: "Joie" },
            { name: "Apathie", code: "A-8/V0", category: 5, group: "Tristesse" },
            { name: "S√©curit√©", code: "A-6/V+2", category: 5, group: "Tristesse" },
            { name: "Qui√©tude", code: "A-5/V+3", category: 5, group: "Tristesse" },
            { name: "Patience", code: "A-7/V+1", category: 5, group: "Tristesse" },
            { name: "Pessimisme", code: "A-6/V-2", category: 5, group: "Tristesse" },
            { name: "D√©shonneur", code: "A-5/V-3", category: 5, group: "Tristesse" },
            { name: "D√©sespoir", code: "A-7/V-1", category: 5, group: "Tristesse" },
            { name: "Incertitude", code: "A0/V-8", category: 5, group: "Peur" },
            { name: "Ins√©curit√©", code: "A+2/V-6", category: 5, group: "Peur" },
            { name: "Inqui√©tude", code: "A+3/V-5", category: 5, group: "Peur" },
            { name: "Impatience", code: "A+1/V-7", category: 5, group: "Peur" },
            { name: "Vuln√©rabilit√©", code: "A-1/V-7", category: 5, group: "Peur" },
            { name: "Impuissance", code: "A-2/V-6", category: 5, group: "Peur" },
            { name: "M√©fiance", code: "A-3/V-5", category: 5, group: "Peur" },
            { name: "Certitude", code: "A0/V+8", category: 5, group: "Courage" },
            { name: "Optimisme", code: "A+2/V+6", category: 5, group: "Courage" },
            { name: "Honneur", code: "A+3/V+5", category: 5, group: "Courage" },
            { name: "Espoir", code: "A+1/V+7", category: 5, group: "Courage" },
            { name: "Tol√©rance", code: "A-2/V+6", category: 5, "group": "Courage" },
            { name: "Justice", code: "A-3/V+5", category: 5, group: "Courage" },
            { name: "Prudence", code: "A-1/V+7", category: 5, group: "Courage" },
            { name: "M√©contentement", code: "A+4/V-4", category: 5, group: "Col√®re" },
            { name: "Contentement", code: "A-4/V+4", category: 5, group: "Calme" },
            { name: "Int√©r√™t", code: "A+4/V+4", category: 5, group: "D√©sir" },
            { name: "D√©sint√©r√™t", code: "A-4/V-4", category: 5, group: "D√©go√ªt" }
        ];

        let emotionalPath = [];

        function parseCode(emotion) {
            const parts = emotion.code.split('/');
            const activationStr = parts[0].replace('A', '').replace(',', '.');
            const valenceStr = parts[1].replace('V', '').replace(',', '.');
            return {
                activation: parseFloat(activationStr),
                valence: parseFloat(valenceStr)
            };
        }

        const processedData = emotionsData.map(d => {
            const { activation, valence } = parseCode(d);
            return { ...d, activation, valence };
        }).filter(d => !isNaN(d.activation) && !isNaN(d.valence));

        const margin = { top: 10, right: 20, bottom: 40, left: 40 };
        const width = 800 - margin.left - margin.right;
        const height = 800 - margin.top - margin.bottom;

        const svg = d3.select("#emotionChart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        svg.append("g").attr("class", "symetrical-lines-group").style("visibility", "hidden");
        svg.append("g").attr("class", "controlateral-lines-group").style("visibility", "hidden");
        svg.append("g").attr("class", "path-group");
        svg.append("circle").attr("class", "intensity-circle").style("visibility", "hidden");

        const xScale = d3.scaleLinear().domain([-8.5, 8.5]).range([0, width]);
        const yScale = d3.scaleLinear().domain([-8.5, 8.5]).range([height, 0]);

        const colorGroups = {
            "Joie": "#fde047", "Tristesse": "#93c5fd", "Peur": "#c084fc", "Courage": "#86efac",
            "Col√®re": "#fca5a5", "Calme": "#67e8f9", "D√©sir": "#f9a8d4", "D√©go√ªt": "#9ca3af",
            "Orientation": "#a5b4fc"
        };
        const colorScale = d3.scaleOrdinal().domain(Object.keys(colorGroups)).range(Object.values(colorGroups));

        const radiusScale = d3.scaleOrdinal()
            .domain([1, 2, 3, 4, 5])
            .range([4, 5, 6, 7, 8]);

        svg.append("defs").append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "-0 -5 10 10").attr("refX", 15).attr("refY", 0)
            .attr("orient", "auto").attr("markerWidth", 6).attr("markerHeight", 6)
            .attr("xoverflow", "visible").append("svg:path")
            .attr("d", "M 0,-5 L 10 ,0 L 0,5").attr("fill", "#2c3e50").style("stroke","none");

        svg.on("click", function(event) {
            if (event.target === this || event.target.className.baseVal.includes('quadrant-bg')) {
                svg.selectAll(".emotion-point")
                    .transition().duration(300)
                    .style("opacity", 0.85).attr("stroke-width", 1);
            }
        });

        const quadrantData = [
            { x: xScale(0), y: yScale(8.5), width: xScale(8.5) - xScale(0), height: yScale(0) - yScale(8.5), color: "rgba(134, 239, 172, 0.07)", label: "V+ / A+", lx: xScale(4.25), ly: yScale(8) },
            { x: xScale(-8.5), y: yScale(8.5), width: xScale(0) - xScale(-8.5), height: yScale(0) - yScale(8.5), color: "rgba(252, 165, 165, 0.07)", label: "V- / A+", lx: xScale(-4.25), ly: yScale(8) },
            { x: xScale(-8.5), y: yScale(0), width: xScale(0) - xScale(-8.5), height: yScale(-8.5) - yScale(0), color: "rgba(147, 197, 253, 0.07)", label: "V- / A-", lx: xScale(-4.25), ly: yScale(-8) },
            { x: xScale(0), y: yScale(0), width: xScale(8.5) - xScale(0), height: yScale(-8.5) - yScale(0), color: "rgba(103, 232, 249, 0.07)", label: "V+ / A-", lx: xScale(4.25), ly: yScale(-8) }
        ];
        svg.selectAll(".quadrant-bg").data(quadrantData).enter().append("rect")
            .attr("class", "quadrant-bg").attr("x", d => d.x).attr("y", d => d.y).attr("width", d => d.width).attr("height", d => d.height).attr("fill", d => d.color);

        const xAxisGrid = d3.axisBottom(xScale).tickSize(-height).tickFormat("").ticks(17);
        const yAxisGrid = d3.axisLeft(yScale).tickSize(-width).tickFormat("").ticks(17);
        svg.append("g").attr("class", "grid x-grid").attr("transform", `translate(0,${height})`).call(xAxisGrid);
        svg.append("g").attr("class", "grid y-grid").call(yAxisGrid);

        svg.append("line").attr("x1", xScale(0)).attr("y1", 0).attr("x2", xScale(0)).attr("y2", height).attr("class", "axis-center-line");
        svg.append("line").attr("x1", 0).attr("y1", yScale(0)).attr("x2", width).attr("y2", yScale(0)).attr("class", "axis-center-line");

        const symetricalPairs = [
            ["Joie", "Tristesse"], ["Peur", "Courage"],
            ["Confusion", "Engourdissement"], ["Appr√©hension", "Stupeur"],
            ["Ambivalence", "Indiff√©rence"], ["H√©sitation", "Doute"],
            ["Agitation", "Apathie"], ["Certitude", "Incertitude"]
        ];

        const controlateralPairs = [
            ["Col√®re", "Calme"], ["D√©sir", "D√©go√ªt"],
            ["Consternation", "Enchantement"], ["Exasp√©ration", "Soulagement"],
            ["Panique", "R√©confort"], ["Euphorie", "Effroi"],
            ["Excitation", "D√©ception"], ["√âmerveillement", "Chagrin"],
            ["Haine", "Affection"], ["Envie", "Admiration"],
            ["Frustration", "Acceptation"], ["Anxi√©t√©", "S√©r√©nit√©"],
            ["Manque", "Pl√©nitude"], ["Amour", "M√©pris"],
            ["Assurance", "Crainte"], ["Engagement", "Rejet"],
            ["Fiert√©", "Honte"], ["√âpanouissement", "Vide"],
            ["Vuln√©rabilit√©", "Invuln√©rabilit√©"], ["Puissance", "Impuissance"],
            ["Confiance", "M√©fiance"], ["Int√©r√™t", "D√©sint√©r√™t"],
            ["Honneur", "D√©shonneur"], ["Optimisme", "Pessimisme"],
            ["Espoir", "D√©sespoir"], ["Prudence", "Imprudence"],
            ["Tol√©rance", "Intol√©rance"], ["Justice", "Injustice"],
            ["Contentement", "M√©contentement"],
            ["S√©curit√©", "Ins√©curit√©"],
            ["Patience", "Impatience"], ["Qui√©tude", "Inqui√©tude"]
        ];

        const xAxis = d3.axisBottom(xScale).ticks(17).tickFormat(d3.format("d"));
        const yAxis = d3.axisLeft(yScale).ticks(17).tickFormat(d3.format("d"));
        svg.append("g").attr("transform", `translate(0,${height})`).call(xAxis);
        svg.append("g").call(yAxis);

        svg.append("text").attr("class", "axis-label").attr("text-anchor", "middle")
            .attr("x", width / 2).attr("y", height + margin.bottom - 5).text("Valence (V)");
        svg.append("text").attr("class", "axis-label").attr("text-anchor", "middle")
            .attr("transform", "rotate(-90)").attr("x", -height / 2).attr("y", -margin.left + 15).text("Activation (A)");

        svg.selectAll(".quadrant-label-text").data(quadrantData).enter().append("text")
            .attr("class", "quadrant-label").attr("x", d => d.lx).attr("y", d => d.ly).text(d => d.label);

        const tooltip = d3.select("body").append("div").attr("class", "tooltip");
        const iaResponseContainer = d3.select("#iaResponseContainer");
        const iaResponseTitle = d3.select("#iaResponseTitle");
        const iaResponseContent = d3.select("#iaResponseContent");

        async function fetchEmotionIdentityCard(emotion) {
            iaResponseContainer.classed("hidden", false);
            iaResponseTitle.text(`Fiche d'Identit√© : ${emotion.name}`);
            iaResponseContent.html('<div class="loading-spinner"></div><p class="text-center text-sm text-gray-500">G√©n√©ration en cours...</p>');

            const prompt = `Pour l'√©motion "${emotion.name}", cr√©e une "fiche d'identit√©" concise en fran√ßais. R√©ponds uniquement avec un objet JSON qui a les cl√©s suivantes: "declencheurs", "marqueurs", "tendance", "besoin_associe". Pour chaque cl√©, fournis une br√®ve description textuelle.`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "declencheurs": { "type": "STRING" },
                            "marqueurs": { "type": "STRING" },
                            "tendance": { "type": "STRING" },
                            "besoin_associe": { "type": "STRING" },
                        },
                        required: ["declencheurs", "marqueurs", "tendance", "besoin_associe"]
                    }
                }
            };
            // IMPORTANT: Remplacez "" par votre cl√© API Google AI Studio.
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Erreur API: ${response.status}`);
                const result = await response.json();
                const data = JSON.parse(result.candidates[0].content.parts[0].text);

                iaResponseContent.html(`
                    <div class="identity-card-section">
                        <h4>D√©clencheurs Cognitifs (Le "Pourquoi")</h4>
                        <p>${data.declencheurs}</p>
                    </div>
                    <div class="identity-card-section">
                        <h4>Marqueurs Somatiques (Le "Comment √ßa se sent")</h4>
                        <p>${data.marqueurs}</p>
                    </div>
                    <div class="identity-card-section">
                        <h4>Tendance Comportementale (Le "Quoi faire")</h4>
                        <p>${data.tendance}</p>
                    </div>
                    <div class="identity-card-section">
                        <h4>Besoin Fondamental Associ√©</h4>
                        <p>${data.besoin_associe}</p>
                    </div>
                `);
            } catch (error) {
                iaResponseContent.text(`D√©sol√©, une erreur est survenue lors de la g√©n√©ration de la fiche d'identit√©.`);
                console.error("Erreur Gemini (Fiche d'Identit√©):", error);
            }
        }

        async function analyzeText() {
            const textToAnalyze = d3.select("#textInput").property("value");
            if (!textToAnalyze.trim()) return;

            iaResponseContainer.classed("hidden", false);
            iaResponseTitle.text("Chemin √âmotionnel Identifi√©");
            iaResponseContent.html('<div class="loading-spinner"></div><p class="text-center text-sm text-gray-500">Analyse en cours...</p>');

            const emotionList = processedData.map(d => d.name);
            const prompt = `√Ä partir du texte suivant, identifie les 3 √† 5 √©motions les plus pertinentes dans l'ordre chronologique o√π elles pourraient appara√Ætre. R√©ponds uniquement avec un tableau JSON contenant les noms des √©motions. Texte: "${textToAnalyze}". Liste d'√©motions possibles: [${emotionList.join(', ')}]`;

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                  responseMimeType: "application/json",
                  responseSchema: {
                    type: "ARRAY",
                    items: { type: "STRING" }
                  }
                }
            };
            // IMPORTANT: Remplacez "" par votre cl√© API Google AI Studio.
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Erreur API: ${response.status}`);
                const result = await response.json();

                const text = result.candidates[0].content.parts[0].text;
                const identifiedEmotionsNames = JSON.parse(text);

                iaResponseContent.text(`Chemin √©motionnel identifi√© : ${identifiedEmotionsNames.join(' ‚Üí ')}`);

                emotionalPath = identifiedEmotionsNames
                    .map(name => processedData.find(d => d.name === name))
                    .filter(d => d);

                drawEmotionalPath();

                svg.selectAll(".emotion-point")
                    .transition().duration(500)
                    .style("opacity", d => emotionalPath.find(p => p.name === d.name) ? 1 : 0.1)
                    .attr("stroke-width", d => emotionalPath.find(p => p.name === d.name) ? 2 : 1);

            } catch (error) {
                iaResponseContent.text("D√©sol√©, une erreur est survenue lors de l'analyse.");
                console.error("Erreur lors de l'analyse du texte:", error);
            }
        }

        function drawEmotionalPath() {
            const pathGroup = svg.select(".path-group");
            pathGroup.html("");

            if (emotionalPath.length < 2) return;

            const lineGenerator = d3.line()
                .x(d => xScale(d.valence))
                .y(d => yScale(d.activation));

            pathGroup.append("path")
                .datum(emotionalPath)
                .attr("class", "path-line")
                .attr("d", lineGenerator)
                .attr("marker-end", "url(#arrowhead)");
        }

        function updateChart(data) {
            const t = svg.transition().duration(500);

            const circles = svg.selectAll(".emotion-point").data(data, d => d.name);
            circles.exit().transition(t).attr("r", 0).remove();

            circles.enter().append("circle")
                .attr("class", "emotion-point cursor-pointer")
                .attr("r", 0)
                .merge(circles)
                .on("mouseover", (event, d) => {
                    d3.select(event.currentTarget).transition().duration(100).attr("r", radiusScale(d.category) + 2).style("opacity", 1).attr("stroke-width", 2);
                    tooltip.transition().duration(100).style("opacity", 1);
                    tooltip.html(`<strong>${d.name}</strong><br/>Code: ${d.code}<br/>(A: ${d.activation}, V: ${d.valence})`)
                        .style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 15) + "px");
                })
                .on("mouseout", (event, d) => {
                    d3.select(event.currentTarget).transition().duration(100).attr("r", radiusScale(d.category)).style("opacity", 0.85).attr("stroke-width", 1);
                    tooltip.transition().duration(300).style("opacity", 0);
                })
                .on("click", (event, d) => {
                    event.stopPropagation();
                    if (d3.select("#pathModeToggle").property("checked")) {
                        if (emotionalPath.length === 0 || emotionalPath[emotionalPath.length - 1] !== d) {
                            emotionalPath.push(d);
                            drawEmotionalPath();
                            svg.selectAll(".emotion-point").classed("path-point-highlight", p => emotionalPath.includes(p));
                        }
                    } else {
                        fetchEmotionIdentityCard(d);
                        const allPairs = [...controlateralPairs, ...symetricalPairs];
                        const oppositePair = allPairs.find(p => p[0] === d.name || p[1] === d.name);
                        const oppositeName = oppositePair ? (oppositePair[0] === d.name ? oppositePair[1] : oppositePair[0]) : null;
                        svg.selectAll(".emotion-point")
                            .transition().duration(300)
                            .style("opacity", p => (p.name === d.name || p.group === d.group || p.name === oppositeName) ? 0.85 : 0.1)
                            .attr("stroke-width", p => p.name === d.name ? 2 : 1);
                    }
                })
                .transition(t)
                .attr("cx", d => xScale(d.valence))
                .attr("cy", d => yScale(d.activation))
                .attr("r", d => radiusScale(d.category))
                .attr("fill", d => colorScale(d.group))
                .attr("stroke", "#2c3e50").attr("stroke-width", 1).style("opacity", 0.85);

            const labels = svg.selectAll(".emotion-label-group").data(data, d => d.name);
            labels.exit().transition(t).style("opacity", 0).remove();

            const labelsEnter = labels.enter().append("g")
                .attr("class", "emotion-label-group")
                .attr("transform", d => `translate(${xScale(d.valence) + 12}, ${yScale(d.activation)})`);

            labelsEnter.append("rect").attr("class", "label-background");
            labelsEnter.append("text").attr("class", "emotion-label-text").attr("dy", "0.35em").text(d => d.name);

            const mergedLabels = labelsEnter.merge(labels);
            mergedLabels.transition(t).attr("transform", d => `translate(${xScale(d.valence) + 12}, ${yScale(d.activation)})`)
                .style("visibility", d3.select("#showNamesToggle").property("checked") ? "visible" : "hidden");

            const controlateralLinesGroup = svg.select(".controlateral-lines-group");
            controlateralLinesGroup.selectAll("*").remove();
            controlateralPairs.forEach(pair => {
                const emotion1 = data.find(d => d.name === pair[0]);
                const emotion2 = data.find(d => d.name === pair[1]);
                if (emotion1 && emotion2) {
                    controlateralLinesGroup.append("line").attr("class", "controlateral-line")
                        .attr("x1", xScale(emotion1.valence)).attr("y1", yScale(emotion1.activation))
                        .attr("x2", xScale(emotion2.valence)).attr("y2", yScale(emotion2.activation))
                        .style("opacity", 0).transition(t).style("opacity", 1);
                }
            });

            const symetricalLinesGroup = svg.select(".symetrical-lines-group");
            symetricalLinesGroup.selectAll("*").remove();
            symetricalPairs.forEach(pair => {
                const emotion1 = data.find(d => d.name === pair[0]);
                const emotion2 = data.find(d => d.name === pair[1]);
                if (emotion1 && emotion2) {
                    symetricalLinesGroup.append("line").attr("class", "symetrical-line")
                        .attr("x1", xScale(emotion1.valence)).attr("y1", yScale(emotion1.activation))
                        .attr("x2", xScale(emotion2.valence)).attr("y2", yScale(emotion2.activation))
                        .style("opacity", 0).transition(t).style("opacity", 1);
                }
            });
        }

        function handleFilterUpdate() {
            const selectedCategories = [];
            d3.selectAll(".category-filter:checked").each(function() {
                selectedCategories.push(+this.value);
            });
            const filteredData = processedData.filter(d => selectedCategories.includes(d.category));
            updateChart(filteredData);
        }

        handleFilterUpdate();

        d3.selectAll(".category-filter").on("change", handleFilterUpdate);

        d3.select("#showNamesToggle").on("change", function(event) {
            const isChecked = event.target.checked;
            svg.selectAll(".emotion-label-group").style("visibility", isChecked ? "visible" : "hidden");
        });

        d3.select("#showControlateralToggle").on("change", function(event) {
            const isChecked = event.target.checked;
            svg.select(".controlateral-lines-group").style("visibility", isChecked ? "visible" : "hidden");
        });

        d3.select("#showSymetricalToggle").on("change", function(event) {
            const isChecked = event.target.checked;
            svg.select(".symetrical-lines-group").style("visibility", isChecked ? "visible" : "hidden");
        });

        d3.select("#showIntensityCircleToggle").on("change", function(event) {
            const isChecked = event.target.checked;
            const attente = processedData.find(d => d.name === 'Attente');

            let maxDistanceSq = 0;
            processedData.forEach(d => {
                const distanceSq = d.valence * d.valence + d.activation * d.activation;
                if (distanceSq > maxDistanceSq) {
                    maxDistanceSq = distanceSq;
                }
            });
            const maxDistance = Math.sqrt(maxDistanceSq);
            const radius = xScale(maxDistance) - xScale(0);

            svg.select(".intensity-circle")
                .attr("cx", xScale(attente.valence))
                .attr("cy", yScale(attente.activation))
                .attr("r", radius)
                .style("visibility", isChecked ? "visible" : "hidden");
        });

        d3.select("#pathModeToggle").on("change", function(event) {
            d3.select("#resetPathBtn").style("display", event.target.checked ? "inline-block" : "none");
            if (!event.target.checked) {
                emotionalPath = [];
                svg.select(".path-group").html("");
                svg.selectAll(".emotion-point").classed("path-point-highlight", false);
            }
        });

        d3.select("#resetPathBtn").on("click", function() {
            emotionalPath = [];
            svg.select(".path-group").html("");
            svg.selectAll(".emotion-point").classed("path-point-highlight", false);
        });

        d3.select("#analyzeTextBtn").on("click", analyzeText);

        const legendContainer = d3.select("#legend");
        Object.entries(colorGroups).forEach(([groupName, color]) => {
            const legendItem = legendContainer.append("div").attr("class", "legend-item");
            legendItem.append("div").attr("class", "legend-color").style("background-color", color);
            legendItem.append("span").text(groupName);

            legendItem.on("mouseover", function() {
                svg.selectAll(".emotion-point")
                    .transition().duration(200)
                    .style("opacity", d => d.group === groupName ? 1.0 : 0.1)
                    .attr("stroke-width", d => d.group === groupName ? 2 : 1);
            })
            .on("mouseout", function() {
                svg.selectAll(".emotion-point")
                    .transition().duration(200)
                    .style("opacity", 0.85)
                    .attr("stroke-width", 1);
            });
        });
    </script>
</body>
</html>
